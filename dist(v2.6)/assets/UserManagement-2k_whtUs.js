var ge=s=>{throw TypeError(s)};var ie=(s,a,t)=>a.has(s)||ge("Cannot "+t);var u=(s,a,t)=>(ie(s,a,"read from private field"),t?t.call(s):a.get(s)),z=(s,a,t)=>a.has(s)?ge("Cannot add the same private member more than once"):a instanceof WeakSet?a.add(s):a.set(s,t),$=(s,a,t,r)=>(ie(s,a,"write to private field"),r?r.call(s,t):a.set(s,t),t),I=(s,a,t)=>(ie(s,a,"access private method"),t);import{E as gs,F as fs,G as fe,H as js,J as be,K as Y,r as o,k as X,u as ys,D as w,j as e,M as vs,I as V,O as g,U as J,m as W,B as k,C as Ns,e as ws,P as me,Q as ue,R as he,V as xe,W as E,X as ee,n as se,Y as De,_ as Ae,$ as Ce,a0 as Se,a1 as _e,L as q,i as pe,a2 as bs,a3 as Re,a4 as Ds,a5 as As,a6 as Ee,a7 as Cs,a8 as Ss,a9 as _s,aa as Rs,ab as Es,ac as Ts,ad as Te,ae as ks,af as Ps,ag as ke,z as Ms,ah as Us,p as Pe,l as Fs,x as Os,y as qs}from"./index-QpcEAcYr.js";import{n as Ls,s as zs,u as $s}from"./useQuery-DWEKjWdE.js";import{C as oe}from"./calendar-DmRmabPV.js";import{L as Is,E as Hs}from"./ErrorState-CdDKPN54.js";import"./LoadingSpinner-De5HNu0Z.js";var U,F,N,R,T,Z,ne,we,Ks=(we=class extends gs{constructor(a,t){super();z(this,T);z(this,U);z(this,F);z(this,N);z(this,R);$(this,U,a),this.setOptions(t),this.bindMethods(),I(this,T,Z).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(a){var r;const t=this.options;this.options=u(this,U).defaultMutationOptions(a),fs(this.options,t)||u(this,U).getMutationCache().notify({type:"observerOptionsUpdated",mutation:u(this,N),observer:this}),t!=null&&t.mutationKey&&this.options.mutationKey&&fe(t.mutationKey)!==fe(this.options.mutationKey)?this.reset():((r=u(this,N))==null?void 0:r.state.status)==="pending"&&u(this,N).setOptions(this.options)}onUnsubscribe(){var a;this.hasListeners()||(a=u(this,N))==null||a.removeObserver(this)}onMutationUpdate(a){I(this,T,Z).call(this),I(this,T,ne).call(this,a)}getCurrentResult(){return u(this,F)}reset(){var a;(a=u(this,N))==null||a.removeObserver(this),$(this,N,void 0),I(this,T,Z).call(this),I(this,T,ne).call(this)}mutate(a,t){var r;return $(this,R,t),(r=u(this,N))==null||r.removeObserver(this),$(this,N,u(this,U).getMutationCache().build(u(this,U),this.options)),u(this,N).addObserver(this),u(this,N).execute(a)}},U=new WeakMap,F=new WeakMap,N=new WeakMap,R=new WeakMap,T=new WeakSet,Z=function(){var t;const a=((t=u(this,N))==null?void 0:t.state)??js();$(this,F,{...a,isPending:a.status==="pending",isSuccess:a.status==="success",isError:a.status==="error",isIdle:a.status==="idle",mutate:this.mutate,reset:this.reset})},ne=function(a){be.batch(()=>{var t,r,i,l,c,h,f,d;if(u(this,R)&&this.hasListeners()){const x=u(this,F).variables,j=u(this,F).context;(a==null?void 0:a.type)==="success"?((r=(t=u(this,R)).onSuccess)==null||r.call(t,a.data,x,j),(l=(i=u(this,R)).onSettled)==null||l.call(i,a.data,null,x,j)):(a==null?void 0:a.type)==="error"&&((h=(c=u(this,R)).onError)==null||h.call(c,a.error,x,j),(d=(f=u(this,R)).onSettled)==null||d.call(f,void 0,a.error,x,j))}this.listeners.forEach(x=>{x(u(this,F))})})},we);function ae(s,a){const t=Y(),[r]=o.useState(()=>new Ks(t,s));o.useEffect(()=>{r.setOptions(s)},[r,s]);const i=o.useSyncExternalStore(o.useCallback(c=>r.subscribe(be.batchCalls(c)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),l=o.useCallback((c,h)=>{r.mutate(c,h).catch(Ls)},[r]);if(i.error&&zs(r.options.throwOnError,[i.error]))throw i.error;return{...i,mutate:l,mutateAsync:i.mutate}}/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=X("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=X("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=X("UserCog",[["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m21.7 16.4-.9-.3",key:"12j9ji"}],["path",{d:"m15.2 13.9-.9-.3",key:"1fdjdi"}],["path",{d:"m16.6 18.7.3-.9",key:"heedtr"}],["path",{d:"m19.1 12.2.3-.9",key:"1af3ki"}],["path",{d:"m19.6 18.7-.4-1",key:"1x9vze"}],["path",{d:"m16.8 12.3-.4-1",key:"vqeiwj"}],["path",{d:"m14.3 16.6 1-.4",key:"1qlj63"}],["path",{d:"m20.7 13.8 1-.4",key:"1v5t8k"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=X("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vs=X("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]),te=()=>{const{user:s}=ys();return{logAction:async t=>{if(s)try{const r=navigator.userAgent,{error:i}=await w.from("audit_log").insert({user_id:s.id,action:t.action,resource:t.resource,metadata:t.metadata||{},user_agent:r,ip_address:"client"});i&&console.error("Failed to log audit entry:",i)}catch(r){console.error("Error logging audit entry:",r)}}}},Bs=({search:s,onSearchChange:a})=>e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(vs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(V,{placeholder:"Pesquisar utilizadores...",value:s,onChange:t=>a(t.target.value),className:"pl-10"})]})}),Me=o.forwardRef(({className:s,...a},t)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:t,className:g("w-full caption-bottom text-sm",s),...a})}));Me.displayName="Table";const Ue=o.forwardRef(({className:s,...a},t)=>e.jsx("thead",{ref:t,className:g("[&_tr]:border-b",s),...a}));Ue.displayName="TableHeader";const Fe=o.forwardRef(({className:s,...a},t)=>e.jsx("tbody",{ref:t,className:g("[&_tr:last-child]:border-0",s),...a}));Fe.displayName="TableBody";const Qs=o.forwardRef(({className:s,...a},t)=>e.jsx("tfoot",{ref:t,className:g("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",s),...a}));Qs.displayName="TableFooter";const de=o.forwardRef(({className:s,...a},t)=>e.jsx("tr",{ref:t,className:g("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",s),...a}));de.displayName="TableRow";const H=o.forwardRef(({className:s,...a},t)=>e.jsx("th",{ref:t,className:g("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",s),...a}));H.displayName="TableHead";const K=o.forwardRef(({className:s,...a},t)=>e.jsx("td",{ref:t,className:g("p-4 align-middle [&:has([role=checkbox])]:pr-0",s),...a}));K.displayName="TableCell";const Gs=o.forwardRef(({className:s,...a},t)=>e.jsx("caption",{ref:t,className:g("mt-4 text-sm text-muted-foreground",s),...a}));Gs.displayName="TableCaption";const Ws=({users:s,editingUser:a,onEditUser:t})=>{const r=l=>{switch(l){case"superuser":return"destructive";case"moderator":return"secondary";default:return"outline"}},i=l=>{switch(l){case"superuser":return"Superuser";case"moderator":return"Moderador";default:return"Utilizador"}};return s.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(J,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Nenhum utilizador encontrado"}),e.jsx("p",{className:"text-muted-foreground",children:"Não existem utilizadores registados no sistema."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block border rounded-lg",children:e.jsxs(Me,{children:[e.jsx(Ue,{children:e.jsxs(de,{children:[e.jsx(H,{children:"Utilizador"}),e.jsx(H,{children:"Email"}),e.jsx(H,{children:"Role"}),e.jsx(H,{children:"Data de Registo"}),e.jsx(H,{children:"Ações"})]})}),e.jsx(Fe,{children:s.map(l=>e.jsxs(de,{className:(a==null?void 0:a.id)===l.id?"bg-blue-50":"",children:[e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:l.full_name||"Sem nome"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[l.id.slice(0,8),"..."]})]})]})}),e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-4 h-4 text-gray-400"}),l.email]})}),e.jsx(K,{children:e.jsx(W,{variant:r(l.role),children:i(l.role)})}),e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4 text-gray-400"}),new Date(l.created_at).toLocaleDateString("pt-PT")]})}),e.jsxs(K,{children:[(a==null?void 0:a.id)!==l.id&&e.jsx(k,{size:"sm",variant:"outline",onClick:()=>t(l),children:e.jsx(ye,{className:"w-4 h-4"})}),(a==null?void 0:a.id)===l.id&&e.jsx(W,{variant:"secondary",children:"A editar..."})]})]},l.id))})]})}),e.jsx("div",{className:"md:hidden space-y-4",children:s.map(l=>e.jsx(Ns,{className:`p-4 ${(a==null?void 0:a.id)===l.id?"bg-blue-50 border-blue-300":""}`,children:e.jsxs(ws,{className:"p-0 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:l.full_name||"Sem nome"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-600",children:l.email})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-600",children:new Date(l.created_at).toLocaleDateString("pt-PT")})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:["ID: ",l.id.slice(0,8),"..."]})]}),e.jsx("div",{className:"flex flex-col items-end gap-2",children:e.jsx(W,{variant:r(l.role),children:i(l.role)})})]}),(a==null?void 0:a.id)!==l.id&&e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>t(l),className:"w-full",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Editar Role"]}),(a==null?void 0:a.id)===l.id&&e.jsx(W,{variant:"secondary",className:"w-full justify-center",children:"A editar..."})]})},l.id))})]})},Ys=({user:s,newRole:a,isLoading:t,onRoleChange:r,onSave:i,onCancel:l})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(me,{value:a,onValueChange:c=>r(c),disabled:t,children:[e.jsx(ue,{className:"w-32",children:e.jsx(he,{})}),e.jsxs(xe,{children:[e.jsx(E,{value:"user",children:"Utilizador"}),e.jsx(E,{value:"moderator",children:"Moderador"}),e.jsx(E,{value:"superuser",children:"Superuser"})]})]}),e.jsx(k,{size:"sm",onClick:i,disabled:t,children:t?"A guardar...":"Guardar"}),e.jsx(k,{size:"sm",variant:"outline",onClick:l,disabled:t,children:"Cancelar"})]}),Xs=({open:s,onOpenChange:a})=>{const[t,r]=o.useState(""),[i,l]=o.useState(""),[c,h]=o.useState(""),[f,d]=o.useState("user"),{toast:x}=ee(),{logAction:j}=te(),{t:b}=se(),O=Y(),D=ae({mutationFn:async({email:n,password:p,fullName:C,role:y})=>{const{data:S,error:_}=await w.auth.admin.createUser({email:n,password:p,email_confirm:!0,user_metadata:{full_name:C}});if(_||!S.user)throw new Error((_==null?void 0:_.message)||"Failed to create user");const{error:Q}=await w.from("profiles").insert({id:S.user.id,email:S.user.email,full_name:C});if(Q)throw new Error(`Failed to create profile: ${Q.message}`);if(y!=="user"){const{error:L}=await w.from("user_roles").insert({user_id:S.user.id,role:y});if(L)throw new Error(`Failed to set user role: ${L.message}`)}return S.user},onSuccess:async n=>{O.invalidateQueries({queryKey:["admin-users"]}),await j({action:"user_created",resource:"user_management",metadata:{userId:n.id,email:n.email,role:f,fullName:i}}),x({title:b("admin.userCreated"),description:`User ${t} has been created successfully.`}),r(""),l(""),h(""),d("user"),a(!1)},onError:n=>{x({title:b("admin.errorCreatingUser"),description:n.message,variant:"destructive"})}}),M=n=>{if(n.preventDefault(),!t||!c||!i){x({title:b("errors.validationError"),description:"Please fill in all required fields.",variant:"destructive"});return}D.mutate({email:t,password:c,fullName:i,role:f})};return e.jsx(De,{open:s,onOpenChange:a,children:e.jsxs(Ae,{className:"sm:max-w-[425px]",children:[e.jsxs(Ce,{children:[e.jsxs(Se,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5"}),"Add New User"]}),e.jsx(_e,{children:"Create a new user account with the specified role and permissions."})]}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"email",children:[b("auth.email")," *"]}),e.jsx(V,{id:"email",type:"email",value:t,onChange:n=>r(n.target.value),placeholder:"user@example.com",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"fullName",children:[b("auth.fullName")," *"]}),e.jsx(V,{id:"fullName",value:i,onChange:n=>l(n.target.value),placeholder:"John Doe",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"password",children:[b("auth.password")," *"]}),e.jsx(V,{id:"password",type:"password",value:c,onChange:n=>h(n.target.value),placeholder:"Secure password",required:!0,minLength:6})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{htmlFor:"role",children:[b("admin.role")," *"]}),e.jsxs(me,{value:f,onValueChange:n=>d(n),children:[e.jsx(ue,{children:e.jsx(he,{})}),e.jsxs(xe,{children:[e.jsx(E,{value:"user",children:"User"}),e.jsx(E,{value:"moderator",children:"Moderator"}),e.jsx(E,{value:"superuser",children:"Superuser"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(k,{type:"button",variant:"outline",onClick:()=>a(!1),children:b("common.cancel")}),e.jsx(k,{type:"submit",disabled:D.isPending,children:D.isPending?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Create User"]})})]})]})]})})};var Oe="AlertDialog",[Js,wa]=bs(Oe,[Re]),P=Re(),qe=s=>{const{__scopeAlertDialog:a,...t}=s,r=P(a);return e.jsx(Ps,{...r,...t,modal:!0})};qe.displayName=Oe;var Zs="AlertDialogTrigger",ea=o.forwardRef((s,a)=>{const{__scopeAlertDialog:t,...r}=s,i=P(t);return e.jsx(Ds,{...i,...r,ref:a})});ea.displayName=Zs;var sa="AlertDialogPortal",Le=s=>{const{__scopeAlertDialog:a,...t}=s,r=P(a);return e.jsx(ks,{...r,...t})};Le.displayName=sa;var aa="AlertDialogOverlay",ze=o.forwardRef((s,a)=>{const{__scopeAlertDialog:t,...r}=s,i=P(t);return e.jsx(As,{...i,...r,ref:a})});ze.displayName=aa;var B="AlertDialogContent",[ta,ra]=Js(B),$e=o.forwardRef((s,a)=>{const{__scopeAlertDialog:t,children:r,...i}=s,l=P(t),c=o.useRef(null),h=Ee(a,c),f=o.useRef(null);return e.jsx(Cs,{contentName:B,titleName:Ie,docsSlug:"alert-dialog",children:e.jsx(ta,{scope:t,cancelRef:f,children:e.jsxs(Ss,{role:"alertdialog",...l,...i,ref:h,onOpenAutoFocus:_s(i.onOpenAutoFocus,d=>{var x;d.preventDefault(),(x=f.current)==null||x.focus({preventScroll:!0})}),onPointerDownOutside:d=>d.preventDefault(),onInteractOutside:d=>d.preventDefault(),children:[e.jsx(Rs,{children:r}),e.jsx(ia,{contentRef:c})]})})})});$e.displayName=B;var Ie="AlertDialogTitle",He=o.forwardRef((s,a)=>{const{__scopeAlertDialog:t,...r}=s,i=P(t);return e.jsx(Es,{...i,...r,ref:a})});He.displayName=Ie;var Ke="AlertDialogDescription",Ve=o.forwardRef((s,a)=>{const{__scopeAlertDialog:t,...r}=s,i=P(t);return e.jsx(Ts,{...i,...r,ref:a})});Ve.displayName=Ke;var la="AlertDialogAction",Be=o.forwardRef((s,a)=>{const{__scopeAlertDialog:t,...r}=s,i=P(t);return e.jsx(Te,{...i,...r,ref:a})});Be.displayName=la;var Qe="AlertDialogCancel",Ge=o.forwardRef((s,a)=>{const{__scopeAlertDialog:t,...r}=s,{cancelRef:i}=ra(Qe,t),l=P(t),c=Ee(a,i);return e.jsx(Te,{...l,...r,ref:c})});Ge.displayName=Qe;var ia=({contentRef:s})=>{const a=`\`${B}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${B}\` by passing a \`${Ke}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${B}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return o.useEffect(()=>{var r;document.getElementById((r=s.current)==null?void 0:r.getAttribute("aria-describedby"))||console.warn(a)},[a,s]),null},oa=qe,na=Le,We=ze,Ye=$e,Xe=Be,Je=Ge,Ze=He,es=Ve;const ca=oa,da=na,ss=o.forwardRef(({className:s,...a},t)=>e.jsx(We,{className:g("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...a,ref:t}));ss.displayName=We.displayName;const as=o.forwardRef(({className:s,...a},t)=>e.jsxs(da,{children:[e.jsx(ss,{}),e.jsx(Ye,{ref:t,className:g("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...a})]}));as.displayName=Ye.displayName;const ts=({className:s,...a})=>e.jsx("div",{className:g("flex flex-col space-y-2 text-center sm:text-left",s),...a});ts.displayName="AlertDialogHeader";const rs=({className:s,...a})=>e.jsx("div",{className:g("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...a});rs.displayName="AlertDialogFooter";const ls=o.forwardRef(({className:s,...a},t)=>e.jsx(Ze,{ref:t,className:g("text-lg font-semibold",s),...a}));ls.displayName=Ze.displayName;const is=o.forwardRef(({className:s,...a},t)=>e.jsx(es,{ref:t,className:g("text-sm text-muted-foreground",s),...a}));is.displayName=es.displayName;const os=o.forwardRef(({className:s,...a},t)=>e.jsx(Xe,{ref:t,className:g(ke(),s),...a}));os.displayName=Xe.displayName;const ns=o.forwardRef(({className:s,...a},t)=>e.jsx(Je,{ref:t,className:g(ke({variant:"outline"}),"mt-2 sm:mt-0",s),...a}));ns.displayName=Je.displayName;const ma=({user:s,open:a,onOpenChange:t})=>{const{toast:r}=ee(),{logAction:i}=te(),{t:l}=se(),c=Y(),h=ae({mutationFn:async d=>{const{error:x}=await w.auth.admin.deleteUser(d);if(x)throw new Error(x.message);await Promise.all([w.from("profiles").delete().eq("id",d),w.from("user_roles").delete().eq("user_id",d),w.from("prompt_history").delete().eq("user_id",d)])},onSuccess:async()=>{c.invalidateQueries({queryKey:["admin-users"]}),await i({action:"user_deleted",resource:"user_management",metadata:{userId:s==null?void 0:s.id,email:s==null?void 0:s.email,role:s==null?void 0:s.role}}),r({title:l("admin.userDeleted"),description:`User ${s==null?void 0:s.email} has been deleted successfully.`}),t(!1)},onError:d=>{r({title:l("admin.errorDeletingUser"),description:d.message,variant:"destructive"})}}),f=()=>{s&&h.mutate(s.id)};return s?e.jsx(ca,{open:a,onOpenChange:t,children:e.jsxs(as,{children:[e.jsxs(ts,{children:[e.jsxs(ls,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(Ms,{className:"w-5 h-5"}),"Delete User Account"]}),e.jsxs(is,{className:"space-y-3",children:[e.jsxs("p",{children:["Are you sure you want to delete the user account for ",e.jsx("strong",{children:s.email}),"?"]}),e.jsxs("div",{className:"bg-red-50 p-3 rounded-lg border border-red-200",children:[e.jsxs("p",{className:"text-red-800 text-sm",children:[e.jsx("strong",{children:"Warning:"})," This action cannot be undone. This will:"]}),e.jsxs("ul",{className:"text-red-700 text-sm mt-2 ml-4 space-y-1",children:[e.jsx("li",{children:"• Permanently delete the user account"}),e.jsx("li",{children:"• Remove all user data and preferences"}),e.jsx("li",{children:"• Delete all associated prompt history"}),e.jsx("li",{children:"• Revoke all access permissions"})]})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600",children:e.jsx("strong",{children:"User Details:"})}),e.jsxs("ul",{className:"text-sm text-gray-700 mt-1 space-y-1",children:[e.jsxs("li",{children:["• Name: ",s.full_name||"N/A"]}),e.jsxs("li",{children:["• Email: ",s.email]}),e.jsxs("li",{children:["• Role: ",s.role]}),e.jsxs("li",{children:["• Registered: ",new Date(s.created_at).toLocaleDateString()]})]})]})]})]}),e.jsxs(rs,{children:[e.jsx(ns,{children:l("common.cancel")}),e.jsx(os,{onClick:f,disabled:h.isPending,className:"bg-red-600 hover:bg-red-700 focus:ring-red-600",children:h.isPending?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-4 h-4 mr-2 animate-spin"}),"Deleting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Vs,{className:"w-4 h-4 mr-2"}),"Delete User"]})})]})]})}):null};var ua="Separator",Ne="horizontal",ha=["horizontal","vertical"],cs=o.forwardRef((s,a)=>{const{decorative:t,orientation:r=Ne,...i}=s,l=xa(r)?r:Ne,h=t?{role:"none"}:{"aria-orientation":l==="vertical"?l:void 0,role:"separator"};return e.jsx(Us.div,{"data-orientation":l,...h,...i,ref:a})});cs.displayName=ua;function xa(s){return ha.includes(s)}var ds=cs;const ms=o.forwardRef(({className:s,orientation:a="horizontal",decorative:t=!0,...r},i)=>e.jsx(ds,{ref:i,decorative:t,orientation:a,className:g("shrink-0 bg-border",a==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...r}));ms.displayName=ds.displayName;const pa=({user:s,open:a,onOpenChange:t})=>{const[r,i]=o.useState(""),[l,c]=o.useState(""),[h,f]=o.useState("user"),{toast:d}=ee(),{logAction:x}=te(),{t:j}=se(),b=Y();o.useEffect(()=>{s&&(i(s.full_name||""),c(s.email||""),f(s.role||"user"))},[s]);const O=ae({mutationFn:async({userId:n,updates:p})=>{const C=[];(p.fullName!==(s==null?void 0:s.full_name)||p.email!==(s==null?void 0:s.email))&&C.push(w.from("profiles").update({full_name:p.fullName,email:p.email}).eq("id",n)),p.email&&p.email!==(s==null?void 0:s.email)&&C.push(w.auth.admin.updateUserById(n,{email:p.email})),p.role&&p.role!==(s==null?void 0:s.role)&&C.push(w.from("user_roles").upsert({user_id:n,role:p.role},{onConflict:"user_id"}));const S=(await Promise.all(C)).filter(_=>_.error);if(S.length>0)throw new Error(S[0].error.message)},onSuccess:async()=>{b.invalidateQueries({queryKey:["admin-users"]}),await x({action:"user_updated",resource:"user_management",metadata:{userId:s==null?void 0:s.id,updates:{fullName:r!==(s==null?void 0:s.full_name)?r:void 0,email:l!==(s==null?void 0:s.email)?l:void 0,role:h!==(s==null?void 0:s.role)?h:void 0}}}),d({title:j("admin.userUpdated"),description:`User ${l} has been updated successfully.`}),t(!1)},onError:n=>{d({title:j("admin.errorUpdatingUser"),description:n.message,variant:"destructive"})}}),D=n=>{if(n.preventDefault(),!s)return;const p={fullName:r.trim(),email:l.trim(),role:h};O.mutate({userId:s.id,updates:p})},M=n=>{switch(n){case"superuser":return"destructive";case"moderator":return"secondary";default:return"outline"}};return s?e.jsx(De,{open:a,onOpenChange:t,children:e.jsxs(Ae,{className:"sm:max-w-[500px]",children:[e.jsxs(Ce,{children:[e.jsxs(Se,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"w-5 h-5"}),"Edit User Profile"]}),e.jsxs(_e,{children:["Update user information and permissions for ",s.email]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-700",children:"Current User Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{children:["ID: ",s.id.slice(0,8),"..."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4 text-gray-400"}),e.jsxs("span",{children:["Since: ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"w-4 h-4 text-gray-400"}),e.jsx(W,{variant:M(s.role),children:s.role})]})]})]}),e.jsx(ms,{}),e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"fullName",children:j("auth.fullName")}),e.jsx(V,{id:"fullName",value:r,onChange:n=>i(n.target.value),placeholder:"Enter full name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"email",children:j("auth.email")}),e.jsx(V,{id:"email",type:"email",value:l,onChange:n=>c(n.target.value),placeholder:"Enter email address"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Changing email will require user to verify new address"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"role",children:j("admin.role")}),e.jsxs(me,{value:h,onValueChange:n=>f(n),children:[e.jsx(ue,{children:e.jsx(he,{})}),e.jsxs(xe,{children:[e.jsx(E,{value:"user",children:"User"}),e.jsx(E,{value:"moderator",children:"Moderator"}),e.jsx(E,{value:"superuser",children:"Superuser"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(k,{type:"button",variant:"outline",onClick:()=>t(!1),children:j("common.cancel")}),e.jsx(k,{type:"submit",disabled:O.isPending,children:O.isPending?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-4 h-4 mr-2 animate-spin"}),"Updating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"Update User"]})})]})]})]})]})}):null},ba=()=>{const[s,a]=o.useState(""),[t,r]=o.useState(null),[i,l]=o.useState(null),[c,h]=o.useState(null),[f,d]=o.useState(!1),[x,j]=o.useState("user"),{toast:b}=ee(),{logAction:O}=te(),{t:D}=se(),{role:M,isSuperuser:n,loading:p}=Fs(),C=Y(),{data:y,isLoading:S,error:_}=$s({queryKey:["admin-users"],queryFn:async()=>{console.log("Fetching users and roles..."),console.log("Current user role:",M,"isSuperuser:",n);const{data:m,error:A}=await w.from("profiles").select("id, email, full_name, created_at").order("created_at",{ascending:!1});if(A)throw console.error("Error fetching profiles:",A),A;console.log("Profiles found:",(m==null?void 0:m.length)||0);const{data:v,error:re}=await w.from("user_roles").select("user_id, role");if(re)throw console.error("Error fetching roles:",re),re;console.log("Roles found:",(v==null?void 0:v.length)||0);const ps=new Map((v==null?void 0:v.map(G=>[G.user_id,G.role]))||[]),le=(m==null?void 0:m.map(G=>({...G,role:ps.get(G.id)||"user"})))||[];return console.log("Users with roles:",le.length),console.log("Sample user:",le[0]),le},enabled:!p&&M!==null}),Q=ae({mutationFn:async({userId:m,role:A})=>{console.log("Updating role for user:",m,"to:",A);const{error:v}=await w.from("user_roles").upsert({user_id:m,role:A},{onConflict:"user_id"});if(v)throw console.error("Error updating role:",v),v},onSuccess:async(m,{userId:A,role:v})=>{C.invalidateQueries({queryKey:["admin-users"]}),await O({action:"role_updated",resource:"user_management",metadata:{userId:A,newRole:v}}),b({title:D("admin.roleUpdated"),description:"User role has been updated successfully."}),r(null)},onError:m=>{console.error("Role update error:",m),b({title:D("admin.errorUpdatingRole"),description:m.message,variant:"destructive"})}}),L=(y==null?void 0:y.filter(m=>{var A,v;return((A=m.email)==null?void 0:A.toLowerCase().includes(s.toLowerCase()))||((v=m.full_name)==null?void 0:v.toLowerCase().includes(s.toLowerCase()))}))||[],us=m=>{r(m),j(m.role)},hs=()=>{t&&Q.mutate({userId:t.id,role:x})},xs=()=>{r(null)};return p||S?e.jsx(Is,{message:D("common.loading")}):n?_?(console.error("UserManagement error:",_),e.jsx(Hs,{message:D("errors.generic"),onRetry:()=>C.invalidateQueries({queryKey:["admin-users"]})})):(console.log("Rendering UserManagement with users:",(y==null?void 0:y.length)||0),console.log("Filtered users:",L.length),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium",children:D("admin.userManagement")}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[D("admin.totalUsers"),": ",(y==null?void 0:y.length)||0," | Your role: ",M]})]}),e.jsxs(k,{onClick:()=>d(!0),className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4"}),"Add User"]})]}),e.jsx(Bs,{search:s,onSearchChange:a}),t?e.jsxs("div",{className:"p-4 border rounded-lg bg-blue-50",children:[e.jsxs("h3",{className:"font-medium mb-2",children:[D("admin.editRole"),": ",t.email]}),e.jsx(Ys,{user:t,newRole:x,isLoading:Q.isPending,onRoleChange:j,onSave:hs,onCancel:xs})]}):null,e.jsx(Ws,{users:L,editingUser:t,onEditUser:us}),L.length===0&&y&&y.length>0&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"No users found matching your search criteria."})}),e.jsx(Xs,{open:f,onOpenChange:d}),e.jsx(pa,{user:i,open:!!i,onOpenChange:m=>!m&&l(null)}),e.jsx(ma,{user:c,open:!!c,onOpenChange:m=>!m&&h(null)})]})):e.jsxs(Os,{children:[e.jsx(Pe,{className:"h-4 w-4"}),e.jsxs(qs,{children:["Access denied. You need superuser privileges to access user management.",e.jsx("br",{}),"Current role: ",M||"unknown"]})]})};export{ba as UserManagement};
