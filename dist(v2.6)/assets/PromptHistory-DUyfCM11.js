import{k as C,u as L,K as D,D as g,n as w,j as e,C as q,e as S,B as v,m as j,aB as b,r as H,X as T,aq as k,o as E,M as P,I,as as K}from"./index-QpcEAcYr.js";import{u as _}from"./useQuery-DWEKjWdE.js";import{C as Q}from"./calendar-DmRmabPV.js";import{S as z}from"./status-indicator-BUKMw0FD.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A=C("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),B=()=>{const{user:t}=L(),i=D(),{data:o=[],isLoading:n,error:f}=_({queryKey:["prompt-history",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const{data:r,error:a}=await g.from("prompt_history").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(50);if(a)throw a;return r||[]},enabled:!!t,staleTime:5*60*1e3,gcTime:10*60*1e3}),{data:y,isLoading:p}=_({queryKey:["analytics",t==null?void 0:t.id],queryFn:async()=>{if(!t)return null;const r=new Date;r.setDate(r.getDate()-30);const{data:a,error:x}=await g.from("prompt_history").select("created_at, original_prompt, improved_prompt").eq("user_id",t.id).gte("created_at",r.toISOString());if(x)throw x;const u=a.length,s=a.reduce((c,h)=>c+h.improved_prompt.length/h.original_prompt.length,0)/u||0,l=a.reduce((c,h)=>{const N=new Date(h.created_at).toISOString().split("T")[0];return c[N]=(c[N]||0)+1,c},{});return{totalPrompts:u,avgImprovement:s,dailyActivity:Object.entries(l).map(([c,h])=>({date:c,prompts:h}))}},enabled:!!t,staleTime:10*60*1e3,gcTime:30*60*1e3});return{promptHistory:o,historyLoading:n,historyError:f,analyticsData:y,analyticsLoading:p,prefetchNextPage:()=>{o.length>=50&&i.prefetchQuery({queryKey:["prompt-history-page-2",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const{data:r,error:a}=await g.from("prompt_history").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).range(50,99);if(a)throw a;return r||[]},staleTime:5*60*1e3})},invalidateHistory:()=>{i.invalidateQueries({queryKey:["prompt-history"]}),i.invalidateQueries({queryKey:["analytics"]})}}},F=({item:t,onCopy:i,onDelete:o})=>{const{t:n}=w();return e.jsx(q,{className:"border-l-4 border-l-blue-500",children:e.jsxs(S,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-600",children:new Date(t.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>o(t.id),className:"text-red-600 hover:text-red-700",children:e.jsx(A,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(j,{variant:"outline",children:n("history.original")}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>i(t.original_prompt,"original"),children:e.jsx(b,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"bg-gray-50 p-3 rounded text-sm max-h-32 overflow-y-auto",children:t.original_prompt})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(j,{variant:"outline",className:"bg-green-50 text-green-800",children:n("history.improved")}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>i(t.improved_prompt,"improved"),children:e.jsx(b,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"bg-green-50 p-3 rounded text-sm max-h-32 overflow-y-auto",children:t.improved_prompt})]})]}),t.analysis&&e.jsxs("div",{className:"mt-4",children:[e.jsx(j,{variant:"outline",className:"mb-2",children:n("history.analysis")}),e.jsx("div",{className:"bg-blue-50 p-3 rounded text-sm",children:t.analysis})]})]})},t.id)},M=()=>{const{t}=w();return e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:t("history.noPrompts")}),e.jsx("p",{className:"text-sm mt-2",children:t("history.noPromptsDesc")})]})},X=()=>{const[t,i]=H.useState(""),{promptHistory:o,historyLoading:n,historyError:f,invalidateHistory:y,prefetchNextPage:p}=B(),{t:d}=w(),{toast:m}=T(),r=o.filter(s=>s.original_prompt.toLowerCase().includes(t.toLowerCase())||s.improved_prompt.toLowerCase().includes(t.toLowerCase())),a=async(s,l)=>{try{await navigator.clipboard.writeText(s),m({title:d("history.copied"),description:d("history.copiedDesc").replace("{type}",l)})}catch{m({title:"Copy failed",description:"Unable to copy to clipboard",variant:"destructive"})}},x=async s=>{try{const{error:l}=await g.from("prompt_history").delete().eq("id",s);if(l)throw l;m({title:d("history.deleted"),description:d("history.deletedDesc")}),y()}catch(l){console.error("Error deleting history item:",l),m({title:"Delete failed",description:"Unable to delete history item",variant:"destructive"})}},u=()=>{y(),m({title:"History refreshed",description:"Latest data has been loaded"})};return k.useEffect(()=>{const s=()=>{window.innerHeight+window.scrollY>=document.body.offsetHeight-1e3&&p()};return window.addEventListener("scroll",s),()=>window.removeEventListener("scroll",s)},[p]),n?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(E,{size:"lg",text:"Loading history..."})}):f?e.jsx(z,{status:"error",message:"Failed to load history. Please try again."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(P,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(I,{placeholder:d("history.search"),value:t,onChange:s=>i(s.target.value),className:"pl-10"})]}),e.jsx(v,{variant:"outline",onClick:u,disabled:n,children:e.jsx(K,{className:"h-4 w-4"})})]}),t&&e.jsxs("div",{className:"text-sm text-gray-600",children:[r.length," of ",o.length," items"]}),e.jsx("div",{className:"space-y-4",children:r.length===0?e.jsx(M,{}):r.map(s=>e.jsx(F,{item:s,onCopy:a,onDelete:x},s.id))}),o.length>=50&&e.jsx("div",{className:"text-center py-4",children:e.jsx("div",{className:"text-sm text-gray-500",children:"Scroll down to load more items"})})]})};export{X as PromptHistory};
